# T-Bank — Blocking Payments Case

## Запрос бизнеса:
1. **Заблокировать платежи конкретного клиента**  
2. **Разблокировать платежи клиента**  
3. **Проверить, заблокирован ли клиент**  
4. **Отличать блокировки мошенников от блокировок добропорядочных клиентов**

Для этого необходимо:
1. Разработать спецификацию в формате OpenAPI;
2. Спроектировать структуру хранения данных (небходимых для пункта 1) в БД.

---

## Структура репозитория
.<br>
├─ ./README.md<br>
├─ ./openapi.yaml<br>
└─ ./db_structure/<br>
   ├─ ./db.sql<br>
   └─ ./ERD_db.png<br>

---

## Обзор спецификации API
Файл: `./openapi.yaml`

### **POST** `/clients/{clientId}/blocks`
**Назначение:** создать активную блокировку клиенту. <br>
**Параметры:**  
- `clientId` — UUID клиента.  
**Тело запроса:**  
- `blockType` — тип блокировки (`FRAUD`, `INCORRECT_DETAILS`, `OTHER`)  
- `reason` — описание причины  
- `expiresAt` — дата снятия

**Коды ответов:**  
- `201` — блокировка создана  
- `409` — активная блокировка уже существует  

---

### **GET** `/clients/{clientId}/blocks`
**Назначение:** получить список всех блокировок клиента. <br>
**Параметры:**  
- `clientId` — UUID клиента.  

**Коды ответов:**  
- `200` — возвращает массив всех блокировок и их данные  
- `404` — нет пользователя с таким `clientId`  

---

### **GET** `/clients/{clientId}/blocks/active`
**Назначение:** проверка, есть ли активная блокировка у клиента. <br>
**Параметры:**
- `clientId` — UUID клиента.

**Коды ответов:**  
- `200` — активная блокировка найдена или отсутствует  
- `404` — клиент не найден  

---

### **POST** `/clients/{clientId}/blocks/{blockId}/release`
**Назначение:** снять блокировку с клиента.  <br>
**Параметры:**  
- `clientId` — UUID клиента  
- `blockId` — UUID блокировки  

**Тело запроса:**
{ "reason": "Уточнение данных клиента" } <br>
**Коды ответов:**  
- `200` — блокировка успешно снята  
- `404` — активная блокировка не найдена  

---

## Обзор структуры базы данных
**ER-диаграмма:** `./db_structure/db.png`

### Таблица `client_block`
Хранит **все блокировки** клиентов (и активные, и завершённые).


`id` - Идентификатор блокировки <br>
`client_id` - Идентификатор клиента <br>
`block_type` - Тип блокировки (`FRAUD`, `INCORRECT_DETAILS`, `OTHER`) <br>
`status` - Статус (`ACTIVE`, `RELEASED`, `EXPIRED`) <br>
`reason` - Причина блокировки <br>
`created_at` - Когда создана <br>
`created_by` - Кто создал <br>
`released_at` - Когда снята <br>
`released_by` - Кто снял <br>
`release_reason` - Причина снятия <br>
`expires_at` - Срок действия блокировки <br>

---

### Таблица `audit_log`
Хранит **журнал действий** — кто, когда и что сделал с блокировкой.


`id` - Идентификатор записи <br>
`event_time` - Дата и время события <br>
`actor` - Кто выполнил действие <br>
`action` - Тип действия (`CREATE_BLOCK`, `RELEASE_BLOCK` и т.д.) <br>n
`client_id` - Идентификатор клиента <br>
`block_id` - Идентификатор блокировки <br>
`details` - Дополнительные данные <br>

---

**SQL-код для создания таблиц:** `./db_structure/db.sql`

---

### Условие, запрещающее вторую активную блокировку
CREATE UNIQUE INDEX IF NOT EXISTS uq_client_block_active
  ON client_block (client_id)
  WHERE status = 'ACTIVE';

