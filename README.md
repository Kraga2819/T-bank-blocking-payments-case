# T-Bank — Blocking Payments Case

## Запрос бизнеса:
1. **Заблокировать платежи конкретного клиента**  
2. **Разблокировать платежи клиента**  
3. **Проверить, заблокирован ли клиент**  
4. **Отличать блокировки мошенников от блокировок добропорядочных клиентов**

Для этого необходимо:
- 1) разработать спецификацию в формате OpenAPI;
- 2) спроектировать структуру хранения данных (небходимых для пункта 1) в БД.

---

## Структура репозитория
.
├─ README.md
├─ openapi.yaml
└─ db_structure/
   ├─ db.sql
   └─ ERD_db.png

---

## Обзор спецификации API
Файл: `openapi.yaml`

### **POST** `/clients/{clientId}/blocks`
**Назначение:** создать активную блокировку клиенту.  
**Параметры:**  
- `clientId` — UUID клиента.  
**Тело запроса:**  
- `blockType` — тип блокировки (`FRAUD`, `INCORRECT_DETAILS`, `OTHER`)  
- `reason` — описание причины  
- `expiresAt` — дата снятия

**Коды ответов:**  
- `201` — блокировка создана  
- `409` — активная блокировка уже существует  

---

### **GET** `/clients/{clientId}/blocks`
**Назначение:** получить список всех блокировок клиента.
**Параметры:**  
- `clientId` — UUID клиента.  

**Коды ответов:**  
- `200` — возвращает массив всех блокировок и их данные  
- `404` — нет пользователя с таким `clientId`  

---

### **GET** `/clients/{clientId}/blocks/active`
**Назначение:** проверка, есть ли активная блокировка у клиента.
**Параметры:**
- `clientId` — UUID клиента.

**Коды ответов:**  
- `200` — активная блокировка найдена или отсутствует  
- `404` — клиент не найден  

---

### **POST** `/clients/{clientId}/blocks/{blockId}/release`
**Назначение:** снять блокировку с клиента.  
**Параметры:**  
- `clientId` — UUID клиента  
- `blockId` — UUID блокировки  

**Тело запроса:**
{ "reason": "Уточнение данных клиента" }
**Коды ответов:**  
- `200` — блокировка успешно снята  
- `404` — активная блокировка не найдена  

---

## Обзор структуры базы данных
**ER-диаграмма:** `db_structure/db.png`

### Таблица `client_block`
Хранит **все блокировки** клиентов (и активные, и завершённые).


`id` - Идентификатор блокировки
`client_id` - Идентификатор клиента |
`block_type` - Тип блокировки (`FRAUD`, `INCORRECT_DETAILS`, `OTHER`)
`status` - Статус (`ACTIVE`, `RELEASED`, `EXPIRED`)
`reason` - Причина блокировки
`created_at` - Когда создана
`created_by` - Кто создал
`released_at` - Когда снята |`released_by` | `varchar` | Кто снял
`release_reason` - Причина снятия
`expires_at` - Срок действия блокировки

---

### Таблица `audit_log`
Хранит **журнал действий** — кто, когда и что сделал с блокировкой.


`id` - Идентификатор записи
`event_time` - Дата и время события
`actor` - Кто выполнил действие
`action` - Тип действия (`CREATE_BLOCK`, `RELEASE_BLOCK` и т.д.)
`client_id` - Идентификатор клиента
`block_id` - Идентификатор блокировки
`details` - Дополнительные данные

---

**SQL-код для создания таблиц:** `db_structure/db.sql`

---

### Условие, запрещающее вторую активную блокировку
CREATE UNIQUE INDEX IF NOT EXISTS uq_client_block_active
  ON client_block (client_id)
  WHERE status = 'ACTIVE';

